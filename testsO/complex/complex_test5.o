class GameObject is
    var id : Integer(0)
    var x : Real(0.0)
    var y : Real(0.0)
    var active : true
    
    this(objId: Integer, posX: Real, posY: Real) is
        id := objId
        x := posX
        y := posY
        active := true
    end
    
    method getId : Integer => id
    method getX : Real => x
    method getY : Real => y
    method isActive : Boolean => active
    
    method setPosition(newX: Real, newY: Real) is
        x := newX
        y := newY
    end
    
    method deactivate is
        active := false
    end
    
    method distanceTo(other: GameObject) : Real is
        var dx : x.Minus(other.getX)
        var dy : y.Minus(other.getY)
        return dx.Mult(dx).Plus(dy.Mult(dy))
    end
    
    method getType : Integer => Integer(0)
    method getValue : Integer => id
    method update : Boolean => active
end

class Player extends GameObject is
    var health : Integer(100)
    var maxHealth : Integer(100)
    var score : Integer(0)
    var level : Integer(1)
    var speed : Real(1.0)
    
    this(objId: Integer, posX: Real, posY: Real) is
        id := objId
        x := posX
        y := posY
        active := true
        health := Integer(100)
        maxHealth := Integer(100)
        score := Integer(0)
        level := Integer(1)
        speed := Real(1.0)
    end
    
    method getHealth : Integer => health
    method getScore : Integer => score
    method getLevel : Integer => level
    method getSpeed : Real => speed
    
    method takeDamage(amount: Integer) : Boolean is
        health := health.Minus(amount)
        if health.LessEqual(Integer(0)) then
            health := Integer(0)
            active := false
            return false
        end
        return true
    end
    
    method heal(amount: Integer) is
        health := health.Plus(amount)
        if health.Greater(maxHealth) then
            health := maxHealth
        end
    end
    
    method addScore(points: Integer) is
        score := score.Plus(points)
        if score.GreaterEqual(level.Mult(Integer(100))) then
            level := level.Plus(Integer(1))
            speed := speed.Plus(Real(0.1))
        end
    end
    
    method move(dx: Real, dy: Real) is
        x := x.Plus(dx.Mult(speed))
        y := y.Plus(dy.Mult(speed))
    end
    
    method getType : Integer => Integer(1)
    method getValue : Integer => health.Plus(score)
    
    method update : Boolean is
        if active.Not then
            return false
        end
        return health.Greater(Integer(0))
    end
end

class Enemy extends GameObject is
    var damage : Integer(10)
    var attackRange : Real(2.0)
    var bounty : Integer(10)
    
    this(objId: Integer, posX: Real, posY: Real, dmg: Integer, range: Real, bnt: Integer) is
        id := objId
        x := posX
        y := posY
        active := true
        damage := dmg
        attackRange := range
        bounty := bnt
    end
    
    method getDamage : Integer => damage
    method getRange : Real => attackRange
    method getBounty : Integer => bounty
    
    method canAttack(target: GameObject) : Boolean is
        var dist : this.distanceTo(target)
        return dist.LessEqual(attackRange.Mult(attackRange))
    end
    
    method attack(player: Player) : Integer is
        if this.canAttack(player) then
            player.takeDamage(damage)
            return damage
        end
        return Integer(0)
    end
    
    method getType : Integer => Integer(2)
    method getValue : Integer => bounty.Mult(damage)
    
    method update : Boolean => active
end

class Collectible extends GameObject is
    var value : Integer(10)
    var collected : false
    
    this(objId: Integer, posX: Real, posY: Real, val: Integer) is
        id := objId
        x := posX
        y := posY
        active := true
        value := val
        collected := false
    end
    
    method getValue : Integer => value
    method isCollected : Boolean => collected
    
    method collect(player: Player) : Boolean is
        if collected then
            return false
        end
        if this.distanceTo(player).LessEqual(Real(1.0)) then
            player.addScore(value)
            collected := true
            active := false
            return true
        end
        return false
    end
    
    method getType : Integer => Integer(3)
    
    method update : Boolean => active.And(collected.Not)
end

class GameWorld is
    var objects : Array[GameObject](100)
    var objectCount : Integer(0)
    var player : Player(Integer(0), Real(0.0), Real(0.0))
    var ticks : Integer(0)
    
    this() is
        objects := Array[GameObject](100)
        objectCount := Integer(0)
        player := Player(Integer(0), Real(0.0), Real(0.0))
        ticks := Integer(0)
    end
    
    method getPlayer : Player => player
    method getTicks : Integer => ticks
    method getObjectCount : Integer => objectCount
    
    method addObject(obj: GameObject) : Boolean is
        if objectCount.GreaterEqual(Integer(100)) then
            return false
        end
        objects.set(objectCount, obj)
        objectCount := objectCount.Plus(Integer(1))
        return true
    end
    
    method getObject(index: Integer) : GameObject is
        return objects.get(index)
    end
    
    method countActiveObjects : Integer is
        var count : Integer(0)
        var i : Integer(0)
        while i.Less(objectCount) loop
            if objects.get(i).isActive then
                count := count.Plus(Integer(1))
            end
            i := i.Plus(Integer(1))
        end
        return count
    end
    
    method countByType(typeId: Integer) : Integer is
        var count : Integer(0)
        var i : Integer(0)
        while i.Less(objectCount) loop
            if objects.get(i).getType.Equal(typeId) then
                count := count.Plus(Integer(1))
            end
            i := i.Plus(Integer(1))
        end
        return count
    end
    
    method sumAllValues : Integer is
        var total : Integer(0)
        var i : Integer(0)
        while i.Less(objectCount) loop
            total := total.Plus(objects.get(i).getValue)
            i := i.Plus(Integer(1))
        end
        return total
    end
    
    method tick is
        ticks := ticks.Plus(Integer(1))
    end
end

class StatCalculator is
    method average(arr: Array[Integer]) : Real is
        if arr.Length.Equal(Integer(0)) then
            return Real(0.0)
        end
        var sum : Integer(0)
        var i : Integer(0)
        while i.Less(arr.Length) loop
            sum := sum.Plus(arr.get(i))
            i := i.Plus(Integer(1))
        end
        return sum.toReal.Div(arr.Length.toReal)
    end
    
    method variance(arr: Array[Integer]) : Real is
        var avg : this.average(arr)
        var sumSq : Real(0.0)
        var i : Integer(0)
        while i.Less(arr.Length) loop
            var diff : arr.get(i).toReal.Minus(avg)
            sumSq := sumSq.Plus(diff.Mult(diff))
            i := i.Plus(Integer(1))
        end
        return sumSq.Div(arr.Length.toReal)
    end
    
    method percentAbove(arr: Array[Integer], threshold: Integer) : Real is
        var count : Integer(0)
        var i : Integer(0)
        while i.Less(arr.Length) loop
            if arr.get(i).Greater(threshold) then
                count := count.Plus(Integer(1))
            end
            i := i.Plus(Integer(1))
        end
        return count.toReal.Mult(Real(100.0)).Div(arr.Length.toReal)
    end
end

class BooleanLogicTest is
    method testAnd(a: Boolean, b: Boolean) : Boolean is
        return a.And(b)
    end
    
    method testOr(a: Boolean, b: Boolean) : Boolean is
        return a.Or(b)
    end
    
    method testNot(a: Boolean) : Boolean is
        return a.Not
    end
    
    method testXor(a: Boolean, b: Boolean) : Boolean is
        return a.And(b.Not).Or(a.Not.And(b))
    end
    
    method complexLogic(a: Boolean, b: Boolean, c: Boolean) : Boolean is
        return a.And(b).Or(c).And(a.Or(b.Not))
    end
end

class TestRunner is
    this() is
        print(Integer(10000))
        
        var p : Player(Integer(1), Real(5.0), Real(5.0))
        print(p.getId)
        print(p.getHealth)
        print(p.getScore)
        print(p.getLevel)
        print(p.getType)
        
        p.addScore(Integer(50))
        print(p.getScore)
        print(p.getLevel)
        
        p.addScore(Integer(60))
        print(p.getScore)
        print(p.getLevel)
        print(p.getSpeed.Mult(Real(10.0)).toInteger)
        
        p.takeDamage(Integer(30))
        print(p.getHealth)
        print(p.isActive)
        
        p.heal(Integer(50))
        print(p.getHealth)
        
        print(Integer(20000))
        
        var e : Enemy(Integer(2), Real(6.0), Real(5.0), Integer(15), Real(3.0), Integer(25))
        print(e.getId)
        print(e.getDamage)
        print(e.getBounty)
        print(e.getType)
        print(e.getValue)
        
        print(e.canAttack(p))
        var dmgDealt : e.attack(p)
        print(dmgDealt)
        print(p.getHealth)
        
        print(Integer(30000))
        
        var c : Collectible(Integer(3), Real(5.0), Real(5.0), Integer(100))
        print(c.getId)
        print(c.getValue)
        print(c.isCollected)
        print(c.getType)
        
        print(c.collect(p))
        print(c.isCollected)
        print(p.getScore)
        print(c.isActive)
        
        print(Integer(40000))
        
        var world : GameWorld()
        print(world.getObjectCount)
        
        world.addObject(Player(Integer(10), Real(0.0), Real(0.0)))
        world.addObject(Enemy(Integer(11), Real(1.0), Real(1.0), Integer(5), Real(2.0), Integer(10)))
        world.addObject(Enemy(Integer(12), Real(2.0), Real(2.0), Integer(8), Real(2.5), Integer(15)))
        world.addObject(Collectible(Integer(13), Real(3.0), Real(3.0), Integer(50)))
        world.addObject(Collectible(Integer(14), Real(4.0), Real(4.0), Integer(75)))
        
        print(world.getObjectCount)
        print(world.countActiveObjects)
        print(world.countByType(Integer(1)))
        print(world.countByType(Integer(2)))
        print(world.countByType(Integer(3)))
        print(world.sumAllValues)
        
        world.tick
        world.tick
        world.tick
        print(world.getTicks)
        
        print(Integer(50000))
        
        var stats : StatCalculator()
        var testData : Array[Integer](5)
        testData.set(Integer(0), Integer(10))
        testData.set(Integer(1), Integer(20))
        testData.set(Integer(2), Integer(30))
        testData.set(Integer(3), Integer(40))
        testData.set(Integer(4), Integer(50))
        
        print(stats.average(testData).toInteger)
        print(stats.variance(testData).toInteger)
        print(stats.percentAbove(testData, Integer(25)).toInteger)
        
        print(Integer(60000))
        
        var logic : BooleanLogicTest()
        print(logic.testAnd(true, true))
        print(logic.testAnd(true, false))
        print(logic.testOr(false, true))
        print(logic.testOr(false, false))
        print(logic.testNot(true))
        print(logic.testNot(false))
        print(logic.testXor(true, false))
        print(logic.testXor(true, true))
        print(logic.complexLogic(true, true, false))
        print(logic.complexLogic(false, false, true))
        
        print(Integer(70000))
        
        var polymorphicArray : Array[GameObject](4)
        polymorphicArray.set(Integer(0), Player(Integer(100), Real(0.0), Real(0.0)))
        polymorphicArray.set(Integer(1), Enemy(Integer(101), Real(1.0), Real(1.0), Integer(10), Real(2.0), Integer(20)))
        polymorphicArray.set(Integer(2), Collectible(Integer(102), Real(2.0), Real(2.0), Integer(50)))
        polymorphicArray.set(Integer(3), GameObject(Integer(103), Real(3.0), Real(3.0)))
        
        var i : Integer(0)
        while i.Less(Integer(4)) loop
            print(polymorphicArray.get(i).getType)
            print(polymorphicArray.get(i).getValue)
            print(polymorphicArray.get(i).update)
            i := i.Plus(Integer(1))
        end
        
        print(Integer(80000))
    end
end
